# PFM (Personal Finance Manager)

## Описание проекта

PFM — это приложение для управления личными финансами, которое позволяет пользователям загружать банковские выписки из различных банков, автоматически парсить и категоризировать транзакции, а также просматривать детальную статистику и аналитику по своим финансам через интерактивные дашборды.

### Основные возможности

- **Мультибанковость** — поддержка выписок из разных банков (Mbank, Bakai Bank, Simbank, O!Bank и др.)
- **Мультивалютность** — работа с разными валютами (KGZ, USD, RUB и др.)
- **Автоматический парсинг** — извлечение транзакций из загруженных файлов (PDF, Excel, CSV)
- **Автокатегоризация** — автоматическое распределение транзакций по категориям на основе правил
- **Кастомные категории** — возможность создавать собственные категории помимо системных
- **Редактирование транзакций** — ручная корректировка с сохранением оригинальных данных
- **Аналитика и дашборды** — визуализация расходов/доходов по категориям, периодам, счетам

### Пользовательский флоу

1. Пользователь регистрируется в системе
2. Добавляет свои банковские счета
3. Загружает выписки из банков
4. Бекенд автоматически парсит файлы и извлекает транзакции
5. Транзакции автоматически категоризируются по правилам
6. Пользователь может корректировать категории и создавать свои правила
7. Приложение отображает статистику и дашборды

---

## Архитектура

### Общая схема

```
┌─────────────────┐         ┌─────────────────────────────────────┐
│                 │         │              Backend                │
│  Flutter App    │ ◄─────► │  ┌───────────┐    ┌─────────────┐  │
│  (iOS/Android)  │   REST  │  │  FastAPI  │───►│  Celery     │  │
│                 │   API   │  │  (API)    │    │  (Workers)  │  │
└─────────────────┘         │  └─────┬─────┘    └──────┬──────┘  │
                            │        │                  │         │
                            │        ▼                  ▼         │
                            │  ┌───────────┐    ┌─────────────┐  │
                            │  │PostgreSQL │    │    Redis    │  │
                            │  │  (Data)   │    │(Queue/Cache)│  │
                            │  └───────────┘    └─────────────┘  │
                            │        │                            │
                            │        ▼                            │
                            │  ┌───────────┐                      │
                            │  │   MinIO   │                      │
                            │  │  (Files)  │                      │
                            │  └───────────┘                      │
                            └─────────────────────────────────────┘
```

### Компоненты

| Компонент | Назначение |
|-----------|------------|
| **FastAPI** | REST API для мобильного приложения |
| **PostgreSQL** | Основное хранилище данных |
| **Redis** | Очередь задач (Celery broker) + кэширование |
| **Celery** | Асинхронная обработка файлов (парсинг, категоризация) |
| **MinIO** | S3-совместимое хранилище для загруженных файлов |

### Почему нужен MinIO (или S3)

Файлы выписок нужно хранить по нескольким причинам:

1. **Перепарсинг** — если улучшили парсер, можно перепарсить старые файлы
2. **Отладка** — при ошибках парсинга нужен доступ к оригиналу
3. **Восстановление** — если пользователь удалил транзакции, можно восстановить из файла
4. **Аудит** — доказательство откуда взялись данные

PostgreSQL не предназначен для хранения бинарных файлов — это неэффективно и замедляет бекапы.

### Флоу обработки файла

```
1. Flutter отправляет файл на /api/uploads
                    ↓
2. FastAPI сохраняет файл в MinIO
                    ↓
3. Создаётся запись в uploads (status = "pending")
                    ↓
4. Задача отправляется в Celery через Redis
                    ↓
5. Celery worker забирает задачу:
   - Скачивает файл из MinIO
   - Определяет парсер по bank.parser_type
   - Парсит файл → список транзакций
   - Для каждой транзакции применяет categorization_rules
   - Сохраняет транзакции в БД
   - Обновляет uploads.status = "done"
                    ↓
6. Flutter получает уведомление или полит статус
                    ↓
7. Пользователь видит транзакции
```

---

## Технологический стек

### Backend

| Технология | Версия | Назначение |
|------------|--------|------------|
| **Python** | 3.11+ | Язык программирования |
| **FastAPI** | 0.100+ | Web-фреймворк для REST API |
| **SQLAlchemy** | 2.0+ | ORM для работы с базой данных |
| **Pydantic** | 2.0+ | Валидация данных и сериализация |
| **Alembic** | 1.12+ | Миграции базы данных |
| **Celery** | 5.3+ | Асинхронные задачи |
| **Redis** | 7+ | Брокер очередей + кэш |
| **PostgreSQL** | 15+ | Основная база данных |
| **MinIO** | latest | Хранилище файлов (S3-compatible) |

### Библиотеки для парсинга

| Библиотека | Назначение |
|------------|------------|
| **pdfplumber** или **PyMuPDF** | Парсинг PDF-выписок |
| **openpyxl** | Парсинг Excel-файлов |
| **pandas** | Обработка CSV и табличных данных |

### Дополнительно

| Технология | Назначение |
|------------|------------|
| **JWT (python-jose)** | Аутентификация |
| **bcrypt/passlib** | Хеширование паролей |
| **pytest** | Тестирование |
| **Docker + docker-compose** | Контейнеризация |

---

## Структура проекта

```
pfm-backend/
├── alembic/                    # Миграции БД
│   └── versions/
├── app/
│   ├── __init__.py
│   ├── main.py                 # Точка входа FastAPI
│   ├── config.py               # Настройки приложения
│   ├── database.py             # Подключение к БД
│   │
│   ├── models/                 # SQLAlchemy модели
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── bank.py
│   │   ├── account.py
│   │   ├── upload.py
│   │   ├── category.py
│   │   ├── transaction.py
│   │   └── categorization_rule.py
│   │
│   ├── schemas/                # Pydantic схемы
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── account.py
│   │   ├── upload.py
│   │   ├── category.py
│   │   └── transaction.py
│   │
│   ├── api/                    # Роуты
│   │   ├── __init__.py
│   │   ├── deps.py             # Зависимости (get_db, get_current_user)
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── router.py       # Главный роутер v1
│   │       ├── auth.py
│   │       ├── users.py
│   │       ├── accounts.py
│   │       ├── uploads.py
│   │       ├── categories.py
│   │       ├── transactions.py
│   │       └── analytics.py
│   │
│   ├── services/               # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── auth.py
│   │   ├── upload.py
│   │   ├── categorization.py
│   │   └── analytics.py
│   │
│   ├── parsers/                # Парсеры выписок
│   │   ├── __init__.py
│   │   ├── base.py             # Базовый класс парсера
│   │   ├── kaspi.py
│   │   ├── halyk.py
│   │   └── forte.py
│   │
│   ├── tasks/                  # Celery задачи
│   │   ├── __init__.py
│   │   └── process_upload.py
│   │
│   └── utils/                  # Утилиты
│       ├── __init__.py
│       ├── security.py
│       └── storage.py          # Работа с MinIO
│
├── tests/
├── docker-compose.yml
├── Dockerfile
├── requirements.txt
└── .env.example
```

---

## Схема базы данных

### ER-диаграмма

```
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│    users      │       │    banks      │       │  categories   │
├───────────────┤       ├───────────────┤       ├───────────────┤
│ id (PK)       │       │ id (PK)       │       │ id (PK)       │
│ email         │       │ name          │       │ user_id (FK)  │──┐
│ password_hash │       │ country       │       │ name          │  │
│ name          │       │ parser_type   │       │ type          │  │
│ created_at    │       │ created_at    │       │ is_system     │  │
└───────┬───────┘       └───────┬───────┘       │ created_at    │  │
        │                       │               └───────┬───────┘  │
        │                       │                       │          │
        ▼                       ▼                       │          │
┌───────────────────────────────────────┐               │          │
│              accounts                 │               │          │
├───────────────────────────────────────┤               │          │
│ id (PK)                               │               │          │
│ user_id (FK) ─────────────────────────┼───────────────┼──────────┘
│ bank_id (FK)                          │               │
│ name                                  │               │
│ currency                              │               │
│ account_number                        │               │
│ created_at                            │               │
└───────────────────┬───────────────────┘               │
                    │                                   │
        ┌───────────┴───────────┐                       │
        ▼                       ▼                       │
┌───────────────┐       ┌───────────────────────────────┴───────┐
│    uploads    │       │              transactions             │
├───────────────┤       ├───────────────────────────────────────┤
│ id (PK)       │       │ id (PK)                               │
│ user_id (FK)  │       │ account_id (FK)                       │
│ account_id(FK)│       │ upload_id (FK)                        │
│ filename      │       │ category_id (FK)                      │
│ file_path     │       │ amount                                │
│ status        │       │ type                                  │
│ error_message │       │ date                                  │
│ uploaded_at   │       │ description                           │
│ processed_at  │       │ counterparty                          │
└───────────────┘       │ original_amount                       │
                        │ original_description                  │
                        │ original_counterparty                 │
                        │ is_edited                             │
                        │ created_at                            │
                        └───────────────────────────────────────┘

┌───────────────────────────────────────┐
│        categorization_rules           │
├───────────────────────────────────────┤
│ id (PK)                               │
│ user_id (FK)                          │
│ category_id (FK)                      │
│ pattern                               │
│ match_type                            │
│ priority                              │
│ created_at                            │
└───────────────────────────────────────┘
```

### Таблицы

#### users
Пользователи системы.

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| email | VARCHAR(255) | Email (уникальный) |
| password_hash | VARCHAR(255) | Хеш пароля |
| name | VARCHAR(100) | Имя пользователя |
| created_at | TIMESTAMP | Дата регистрации |

#### banks
Справочник поддерживаемых банков. Заполняется администратором.

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| name | VARCHAR(100) | Название банка ("Kaspi", "Halyk") |
| country | VARCHAR(2) | Код страны (KZ, RU) |
| parser_type | VARCHAR(50) | Идентификатор парсера ("kaspi_pdf", "halyk_excel") |
| created_at | TIMESTAMP | Дата создания |

#### accounts
Банковские счета пользователей.

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID (FK) | Ссылка на пользователя |
| bank_id | UUID (FK) | Ссылка на банк |
| name | VARCHAR(100) | Название счёта ("Моя карта Kaspi") |
| currency | VARCHAR(3) | Код валюты (KZT, USD, RUB) |
| account_number | VARCHAR(50) | Номер счёта (опционально, для матчинга) |
| created_at | TIMESTAMP | Дата создания |

#### uploads
Загруженные файлы выписок.

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID (FK) | Ссылка на пользователя |
| account_id | UUID (FK) | К какому счёту относится выписка |
| filename | VARCHAR(255) | Оригинальное имя файла |
| file_path | VARCHAR(500) | Путь в MinIO |
| status | VARCHAR(20) | Статус: pending, processing, done, error |
| error_message | TEXT | Сообщение об ошибке (если status = error) |
| uploaded_at | TIMESTAMP | Дата загрузки |
| processed_at | TIMESTAMP | Дата окончания обработки |

#### categories
Категории транзакций (системные и пользовательские).

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID (FK) | NULL для системных, иначе ID владельца |
| name | VARCHAR(100) | Название категории |
| type | VARCHAR(10) | Тип: income, expense |
| is_system | BOOLEAN | true для системных категорий |
| created_at | TIMESTAMP | Дата создания |

**Системные категории (user_id = NULL):**
- Еда
- Транспорт
- Развлечения
- Покупки
- Здоровье
- Коммунальные услуги
- Переводы
- Зарплата
- Прочее

#### transactions
Финансовые транзакции.

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| account_id | UUID (FK) | Ссылка на счёт |
| upload_id | UUID (FK) | Из какого файла (NULL если вручную) |
| category_id | UUID (FK) | Категория (NULL если не определена) |
| amount | DECIMAL(15,2) | Сумма транзакции |
| type | VARCHAR(10) | Тип: income, expense, transfer |
| date | DATE | Дата транзакции |
| description | TEXT | Описание |
| counterparty | VARCHAR(255) | Контрагент (Glovo, Magnum, и т.д.) |
| original_amount | DECIMAL(15,2) | Оригинальная сумма из выписки |
| original_description | TEXT | Оригинальное описание из выписки |
| original_counterparty | VARCHAR(255) | Оригинальный контрагент из выписки |
| is_edited | BOOLEAN | Редактировал ли пользователь |
| created_at | TIMESTAMP | Дата создания записи |

**Индексы:**
- (account_id, date) — для выборки транзакций за период
- (category_id) — для агрегации по категориям
- (upload_id) — для связи с загрузкой

#### categorization_rules
Правила автоматической категоризации.

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID (FK) | NULL для системных правил, иначе ID владельца |
| category_id | UUID (FK) | Какую категорию назначать |
| pattern | VARCHAR(255) | Паттерн для поиска ("Glovo", "Яндекс Такси") |
| match_type | VARCHAR(20) | Тип сопоставления: exact, contains, regex |
| priority | INTEGER | Приоритет (выше число = выше приоритет) |
| created_at | TIMESTAMP | Дата создания |

**Логика применения:**
1. Берём description и counterparty транзакции
2. Ищем все подходящие правила (сначала пользовательские, потом системные)
3. Сортируем по priority DESC
4. Применяем первое совпавшее правило

---

## API Endpoints (планируемые)

### Auth
- `POST /api/v1/auth/register` — регистрация
- `POST /api/v1/auth/login` — вход, получение JWT
- `POST /api/v1/auth/refresh` — обновление токена

### Users
- `GET /api/v1/users/me` — текущий пользователь
- `PATCH /api/v1/users/me` — обновление профиля

### Accounts
- `GET /api/v1/accounts` — список счетов пользователя
- `POST /api/v1/accounts` — создание счёта
- `GET /api/v1/accounts/{id}` — детали счёта
- `PATCH /api/v1/accounts/{id}` — обновление счёта
- `DELETE /api/v1/accounts/{id}` — удаление счёта

### Banks
- `GET /api/v1/banks` — список поддерживаемых банков

### Uploads
- `POST /api/v1/uploads` — загрузка файла выписки
- `GET /api/v1/uploads` — история загрузок
- `GET /api/v1/uploads/{id}` — статус обработки
- `DELETE /api/v1/uploads/{id}` — удаление загрузки и связанных транзакций

### Categories
- `GET /api/v1/categories` — все категории (системные + пользовательские)
- `POST /api/v1/categories` — создание пользовательской категории
- `PATCH /api/v1/categories/{id}` — обновление категории
- `DELETE /api/v1/categories/{id}` — удаление категории

### Transactions
- `GET /api/v1/transactions` — список транзакций (с фильтрами)
- `GET /api/v1/transactions/{id}` — детали транзакции
- `PATCH /api/v1/transactions/{id}` — редактирование транзакции
- `DELETE /api/v1/transactions/{id}` — удаление транзакции
- `POST /api/v1/transactions` — ручное создание транзакции

### Categorization Rules
- `GET /api/v1/rules` — список правил пользователя
- `POST /api/v1/rules` — создание правила
- `DELETE /api/v1/rules/{id}` — удаление правила

### Analytics
- `GET /api/v1/analytics/summary` — общая сводка (доходы/расходы за период)
- `GET /api/v1/analytics/by-category` — расходы по категориям
- `GET /api/v1/analytics/by-period` — динамика по дням/неделям/месяцам
- `GET /api/v1/analytics/by-account` — статистика по счетам